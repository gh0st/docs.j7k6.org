I"p<p>I recently had a problem with a new Hetzner Root Server from the <em>PX121</em> product line, where I tried to install <em>VMware ESXi</em> from a mounted ISO on the Hetzner <em>Lantronix</em> KVM console.</p>

<p>Everytime I mounted the ISO, the keyboard stopped working inside of the KVM console session. So I contacted Hetzner Support, which claimed that “<em>installing from a mounted ISO is not officially supported, so there is nothing they could do about it</em>”, also, “<em>mounting an ISO on the KVM console has a known bug, where it’s disabling all other USB devices on the KVM device</em>”  :(
…Which basically means that installing ESXi from a mounted ISO is off the table.</p>

<p>My initial plan was to install ESXi to a USB drive I ordered with the server, so I would have a clean system on the USB drive and a full RAID-10 as a datastore, separated from it.
Of cause I could’ve just <code class="highlighter-rouge">dd</code> the ESXi ISO on the USB drive and boot from that, but than I would’ve been forced to install ESXi on the RAID directly, which I wanted to avoid by any means.</p>

<p>So the only option left was this trick: Make the RAID the bootable ESXi installer, boot from it and install ESXi on the USB drive from there.</p>

<p>This is how made the RAID a bootable ESXi installer disk:</p>

<ol>
  <li>Boot the Server into <em>Rescue</em> mode and login via SSH.</li>
  <li>Install required packages:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get <span class="nb">install </span>dosfstools mtools syslinux
</code></pre></div>    </div>
  </li>
  <li>Download the ESXi ISO:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">--progress-bar</span> <span class="nt">-o</span> VMware-VMvisor-Installer-6.5.0-4564106.x86_64.iso https://mirror.hetzner.de/bootimages/vmware/VMware-VMvisor-Installer-6.5.0-4564106.x86_64.iso
</code></pre></div>    </div>
  </li>
  <li>Create partition Table with <code class="highlighter-rouge">fdisk /dev/sda</code>:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>d
o
n
p
2048
+2G
w
</code></pre></div>    </div>
  </li>
  <li>Reload partition table:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>partprobe <span class="o">&amp;&amp;</span> <span class="nb">sync</span>
</code></pre></div>    </div>
  </li>
  <li>Format partition as <em>FAT</em>:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkfs.vfat <span class="nt">-F</span> 32 /dev/sda1
</code></pre></div>    </div>
  </li>
  <li>Install <em>Syslinux</em> Bootloader on partition <code class="highlighter-rouge">/dev/sda1</code>:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>syslinux /dev/sda1
</code></pre></div>    </div>
  </li>
  <li>Write <em>MBR</em> to RAID disk:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/usr/lib/syslinux/mbr/mbr.bin <span class="nv">of</span><span class="o">=</span>/dev/sda
</code></pre></div>    </div>
  </li>
  <li>Create mount points:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> /mnt/<span class="o">{</span>iso,raid<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>Mount ESXi ISO:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mount <span class="nt">-o</span> loop VMware-VMvisor-Installer-6.5.0-4564106.x86_64.iso /mnt/iso
</code></pre></div>    </div>
  </li>
  <li>Mount <code class="highlighter-rouge">/dev/sda1</code>:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mount /dev/sda1 /mnt/raid
</code></pre></div>    </div>
  </li>
  <li>Copy files from ESXi ISO to RAID disk:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> <span class="nt">-r</span> /mnt/iso/<span class="k">*</span> /mnt/raid/
</code></pre></div>    </div>
  </li>
  <li>Copy <em>Sylinux</em> files:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> /mnt/raid/isolinux.cfg /mnt/raid/syslinux.cfg
<span class="nb">cp</span> /usr/lib/syslinux/modules/bios/<span class="k">*</span>.c32 /mnt/raid/
</code></pre></div>    </div>
  </li>
  <li>Unmount RAID:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>umount /mnt/raid
<span class="nb">sync</span>
</code></pre></div>    </div>
  </li>
  <li><code class="highlighter-rouge">reboot</code></li>
  <li>Boot from RAID drive.</li>
  <li>Install ESXi to the USB drive.</li>
  <li>After ESXi is installed successfully, boot into <em>Rescue</em> mode again to wipe the RAID drive’s partition table (so it can be initialized as datastore in ESXi, like it was supposed to):
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/dev/sda <span class="nv">bs</span><span class="o">=</span>16 <span class="nv">count</span><span class="o">=</span>16 <span class="o">&amp;&amp;</span> <span class="nb">sync</span>
</code></pre></div>    </div>
  </li>
  <li>Reboot</li>
  <li>Run ESXi from USB drive &amp; have fun!</li>
</ol>

<hr />
<ol>
  <li><a href="https://raymii.org/s/tutorials/VMWare-ESXi-5-USB-installer.html">https://raymii.org/s/tutorials/VMWare-ESXi-5-USB-installer.html</a></li>
</ol>
:ET