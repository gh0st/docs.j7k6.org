I"8<blockquote>
  <p><strong>Disclaimer:</strong> This can kill RAID controllers!</p>
</blockquote>

<p>I needed the <a href="https://www.broadcom.com/products/storage/raid-controllers/megaraid-sas-9341-4i">Avago MegaRAID SAS 9341-4i</a> RAID controller to pretend being an HBA in a <a href="http://www.dell.com/en-us/work/shop/productdetails/poweredge-t30">Dell Poweredge T30</a>, because <em>VMWare ESXi 6.5</em> <a href="https://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=2091600">doesn‚Äôt support HDDs with 4K sectors</a>, like the <em>Seagate IronWolf 8TB</em> in this case. Using the RAID Controller as a fake HBA isn‚Äôt solving the 4K sector problem, but it lets the harddrives present themselves as single disks to a <em>FreeNAS</em> VM in <em>ESXi</em> via <em>PCI Passthrough</em>, which was what I wanted to accomplish.</p>

<p>Since the <em>9341-4i</em> is kind of an upgraded <em>9300-4i</em> HBA card with a RAID controller on it, it needed to be <em>crossflashed</em> with an ‚Äú<em>IT</em> mode‚Äù (initiator target) firmware for the <em>9300-4i</em>.</p>

<p>For several reasons, flashing the new firmware wasn‚Äôt easy on the <em>Poweredge T30</em>. Using the <code class="highlighter-rouge">sas3flash</code> utility from within <em>ESXi</em> or <em>Windows</em> wasn‚Äôt working. The only thing that worked was flashing from UEFI. If only the <em>T30</em> had a built-in UEFI shell‚Ä¶ of course it doesn‚Äôt (<em>rEFInd</em> to the rescue!).</p>

<p>Here is what I did to get the firmware flashed on the RAID controller:</p>

<ol>
  <li>Disconnect ALL drives.</li>
  <li>Short-circuit the <em>TP12</em> pins on the RAID controller card with a jumper.</li>
  <li><code class="highlighter-rouge">dd</code> <a href="https://sourceforge.net/projects/refind/files/0.10.7/refind-flashdrive-0.10.7.zip/download">rEFInd</a> image to USB flashdrive #1.</li>
  <li>Get the UEFI Flash Utility (<em>Installer_P14_for_UEFI</em>) and the firmware package (<em>9300_4i_Package_P14_IR_IT_FW_BIOS_for_MSDOS_Windows</em>) from <a href="https://www.broadcom.com/products/storage/host-bus-adapters/sas-9300-4i?pname=MGA-43728#downloads">Broadcom</a>.</li>
  <li>Put the following files to the root of FAT formatted USB flashdrive #2:
    <ul>
      <li>Installer_P14_for_UEFI/sas3flash_udk_uefi_x64_rel/<strong>sas3flash.efi</strong></li>
      <li>9300_4i_Package_P14_IR_IT_FW_BIOS_for_MSDOS_Windows/Firmware/<strong>SAS9300_4i_IT.bin</strong></li>
    </ul>
  </li>
  <li>Disconnect all drive connectors.</li>
  <li>Connect both USB flashdrives.</li>
  <li>Power on &amp; boot from USB flashdrive #1 (<em>rEFInd</em>) into the EFI Shell.</li>
  <li>Select USB flashdrive #2:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fs0:
</code></pre></div>    </div>
  </li>
  <li>Run the UEFI Flash Utility to write the new Firmware to the RAID controller:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sas3flash.efi -c 0 -f SAS9300_4i_IT.bin
</code></pre></div>    </div>
  </li>
  <li>Power off.</li>
  <li>Reconnect all drives &amp; remove jumper from the TP12 pins.</li>
  <li>Power on &amp; have fun!</li>
</ol>

<hr />
<ol>
  <li><a href="https://www.bussink.ch/?p=1489">https://www.bussink.ch/?p=1489</a></li>
  <li><a href="https://forums.servethehome.com/index.php?threads/crossflashing-of-lsi-9341-8i-to-lsi-9300-8i-success-but-no-smart-pass-through.3522/">https://forums.servethehome.com/index.php?threads/crossflashing-of-lsi-9341-8i-to-lsi-9300-8i-success-but-no-smart-pass-through.3522/</a></li>
</ol>
:ET